<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Attendance Viewer</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 15px;
}

h1, h2 {
    text-align: center;
}

label {
    font-weight: bold;
}

select {
    width: 100%;
    max-width: 400px;
    padding: 12px;
    font-size: 18px;
    margin-top: 5px;
}

.card {
    max-width: 400px;
    margin: 20px auto;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    font-size: 16px;
}

.row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.label {
    font-weight: bold;
}

.value {
    text-align: right;
    max-width: 220px;
    word-wrap: break-word;
}

.clickable {
    color: #0066cc;
    font-weight: bold;
    cursor: pointer;
    text-decoration: underline;
}

.status-eligible {
    color: green;
    font-weight: bold;
}

.status-not-eligible {
    color: red;
    font-weight: bold;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
}

.modal-content {
    background: #fff;
    margin: 20% auto;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 10px;
    font-size: 16px;
}

.modal-content h3 {
    margin-top: 0;
    text-align: center;
}

.date-list {
    max-height: 200px;
    overflow-y: auto;
    line-height: 1.6;
    text-align: left;
}

.close-btn {
    text-align: center;
    margin-top: 15px;
}

.close-btn button {
    padding: 8px 20px;
    font-size: 16px;
}

</style>
</head>

<body>

<h1>Android Application Development</h1>
<h2>Student Attendance</h2>

<label>Select Section</label>
<select id="sectionSelect" onchange="loadAttendanceFile()">
    <option value="">-- Select --</option>
    <option value="csea">CSE A</option>
    <option value="cseb">CSE B</option>
</select>

<br><br>

<label>Select Attendance Type</label>
<select id="typeSelect" onchange="loadAttendanceFile()">
    <option value="">-- Select --</option>
    <option value="t">Theory</option>
    <option value="p">Practical</option>
</select>

<br><br>

<label>Select Enrollment Number</label>
<select id="enrollmentSelect" onchange="filterAttendance()">
    <option value="">-- Select --</option>
</select>

<div id="attendanceCard" class="card"></div>

<script>
let attendanceData = [];

function loadAttendanceFile() {
    const section = sectionSelect.value;
    const type = typeSelect.value;

    if (!section || !type) return;

    const file = section + type + ".csv"; // cseat.csv, cseap.csv...

    fetch(file)
        .then(res => res.text())
        .then(data => {
            attendanceData = [];
            const rows = data.trim().split("\n");
            rows.shift(); // remove header

            rows.forEach(row => {
                const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);

                if (cols.length < 9) return;

               attendanceData.push({
                    enroll: cols[0].trim(),
                    name: cols[1].trim(),
                    type: cols[2].trim(),
                    tp: cols[3].trim(),
                    tab: cols[4].trim(),
                    per: cols[5].trim(),
                    sta: cols[6].trim(),
                    presentDates: cols[7].replace(/"/g, "").trim(),
                    absentDates: cols[8].replace(/"/g, "").trim(),
                    lastUpdated: cols[9].replace(/"/g, "").trim()   // ✅ NEW
                });


            });

            loadEnrollmentDropdown();
        });
}

function loadEnrollmentDropdown() {
    enrollmentSelect.innerHTML = '<option value="">-- Select --</option>';

    [...new Set(attendanceData.map(a => a.enroll))].forEach(enroll => {
        const opt = document.createElement("option");
        opt.value = enroll;
        opt.textContent = enroll;
        enrollmentSelect.appendChild(opt);
    });

    attendanceCard.innerHTML = "";
}

function filterAttendance() {
    const enroll = enrollmentSelect.value;
    const result = attendanceData.find(a => a.enroll === enroll);
    if (!result) return;

    const statusClass =
        result.sta.toLowerCase().includes("eligible")
        ? "status-eligible"
        : "status-not-eligible";

    attendanceCard.innerHTML = `
        <div class="row"><div class="label">Enrollment No</div><div class="value">${result.enroll}</div></div>
        <div class="row"><div class="label">Name</div><div class="value">${result.name}</div></div>
        <div class="row"><div class="label">Type</div><div class="value">${result.type}</div></div>

        <div class="row">
            <div class="label">Total Present</div>
            <div class="value clickable"
                 onclick="showMessage('Present Dates', '${result.presentDates || 'No data'}')">
                 ${result.tp}
            </div>
        </div>

        <div class="row">
            <div class="label">Total Absent</div>
            <div class="value clickable"
                 onclick="showMessage('Absent Dates', '${result.absentDates || 'No data'}')">
                 ${result.tab}
            </div>
        </div>

        <div class="row"><div class="label">Percentage</div><div class="value">${result.per}</div></div>
        <div class="row"><div class="label">Status</div><div class="value ${statusClass}">${result.sta}</div></div>
        <div class="row"><div class="label">Attendance updated till</div><div class="value">${result.lastUpdated}</div>
        </div>
        <div id="dateModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <div id="modalBody" class="date-list"></div>
        <div class="close-btn">
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
</div>


    `;
}

function showMessage(title, message) {
    document.getElementById("modalTitle").innerText = title;

    // Convert comma-separated dates into line-by-line format
    let formatted = message
        ? message.split(",").map(d => "• " + d.trim()).join("<br>")
        : "No data";

    document.getElementById("modalBody").innerHTML = formatted;
    document.getElementById("dateModal").style.display = "block";
}

function closeModal() {
    document.getElementById("dateModal").style.display = "none";
}

</script>

</body>
</html>
